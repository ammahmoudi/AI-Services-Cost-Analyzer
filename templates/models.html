{% extends "base.html" %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>AI Models</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn" style="background: #6b7280;" onclick="toggleViewMode()" title="Toggle between detailed and simple view">
                üìä Simple View
            </button>
            <button class="btn" style="background: #8b5cf6;" onclick="showLLMExtractionModal()" title="Use LLM to fix model types, tags, and metadata">
                ü§ñ Run LLM Extraction
            </button>
            <button class="btn" style="background: #10b981;" onclick="showCreateModal()">
                ‚ûï Create New Model
            </button>
            <button class="btn" style="background: #f59e0b;" onclick="showRemoveDuplicatesDialog()" title="Remove duplicate models from selected source">
                üîÑ Remove Duplicates
            </button>
            <button class="btn btn-danger" onclick="showDeleteAllDialog()" style="background: #dc2626;">
                üóëÔ∏è Delete All Models
            </button>
        </div>
    </div>
    
    <!-- Missing Data Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Total Models</div>
            <div style="font-size: 2rem; font-weight: bold; color: #111827;">{{ stats.total }}</div>
        </div>
        <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; border: 1px solid #fde68a; cursor: pointer;" onclick="filterMissingData('cost')">
            <div style="font-size: 0.875rem; color: #92400e; margin-bottom: 0.5rem;">Missing Cost</div>
            <div style="font-size: 2rem; font-weight: bold; color: #92400e;">{{ stats.missing_cost }}</div>
        </div>
        <div style="padding: 1rem; background: #dbeafe; border-radius: 8px; border: 1px solid #93c5fd; cursor: pointer;" onclick="filterMissingData('llm')">
            <div style="font-size: 0.875rem; color: #1e40af; margin-bottom: 0.5rem;">Missing LLM Data</div>
            <div style="font-size: 2rem; font-weight: bold; color: #1e40af;">{{ stats.missing_llm }}</div>
        </div>
        <div style="padding: 1rem; background: #e0e7ff; border-radius: 8px; border: 1px solid #c7d2fe; cursor: pointer;" onclick="filterMissingData('schema')">
            <div style="font-size: 0.875rem; color: #3730a3; margin-bottom: 0.5rem;">Missing Schema</div>
            <div style="font-size: 2rem; font-weight: bold; color: #3730a3;">{{ stats.missing_schema }}</div>
        </div>
        <div style="padding: 1rem; background: #fce7f3; border-radius: 8px; border: 1px solid #fbcfe8; cursor: pointer;" onclick="filterMissingData('raw')">
            <div style="font-size: 0.875rem; color: #831843; margin-bottom: 0.5rem;">Missing Raw Data</div>
            <div style="font-size: 2rem; font-weight: bold; color: #831843;">{{ stats.missing_raw }}</div>
        </div>
    </div>
    
    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <form method="GET" id="filterForm" style="display: flex; gap: 1rem; flex: 1; flex-wrap: wrap;">
            <input type="text" name="search" placeholder="Search models..." value="{{ search }}" style="flex: 1; min-width: 200px;">
            <select name="source_id" id="sourceFilter" style="flex: 0 0 200px;">
                <option value="">All Sources</option>
                {% for source in sources %}
                    <option value="{{ source.id }}" {% if current_source == source.id %}selected{% endif %}>
                        {{ source.name }}
                    </option>
                {% endfor %}
            </select>
            <select name="type" style="flex: 0 0 200px;">
                <option value="">All Types</option>
                {% for type in model_types %}
                    <option value="{{ type }}" {% if current_type == type %}selected{% endif %}>
                        {{ type|replace('-', ' ')|title }}
                    </option>
                {% endfor %}
            </select>
            <select name="category" style="flex: 0 0 200px;">
                <option value="">All Categories</option>
                {% for cat in categories %}
                    <option value="{{ cat }}" {% if current_category == cat %}selected{% endif %}>
                        {{ cat }}
                    </option>
                {% endfor %}
            </select>
            <div style="position: relative; flex: 0 0 200px;">
                <select id="tagsSelect" multiple style="height: 38px; overflow: hidden; cursor: pointer;" onchange="updateTagsDisplay()" title="Hold Ctrl/Cmd to select multiple tags">
                    {% for tag in all_tags %}
                        <option value="{{ tag }}" {% if tag in current_tags %}selected{% endif %}>
                            {{ tag }}
                        </option>
                    {% endfor %}
                </select>
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 38px; background: white; border: 1px solid #d1d5db; border-radius: 4px; padding: 0.5rem; pointer-events: none; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-size: 0.875rem; display: flex; align-items: center; justify-content: space-between;">
                    <span id="tagsDisplay" style="color: #6b7280;">All Tags</span>
                    <span style="color: #9ca3af; font-size: 0.75rem;">‚ñº</span>
                </div>
            </div>
            <!-- Hidden inputs for tags multi-select -->
            <div id="tagsHiddenInputs"></div>
            <select name="missing_data" id="missingDataFilter" style="flex: 0 0 200px;">
                <option value="">All Models</option>
                <option value="cost" {% if missing_data == 'cost' %}selected{% endif %}>Missing Cost</option>
                <option value="llm" {% if missing_data == 'llm' %}selected{% endif %}>Missing LLM Data</option>
                <option value="schema" {% if missing_data == 'schema' %}selected{% endif %}>Missing Schema</option>
                <option value="raw" {% if missing_data == 'raw' %}selected{% endif %}>Missing Raw Data</option>
            </select>
            <button type="submit" class="btn">Filter</button>
        </form>
        {% if search or current_source or current_type or missing_data %}
        <button type="button" class="btn" style="background: #f59e0b;" onclick="refetchFiltered()">
            üîÑ Re-fetch Filtered
        </button>
        {% endif %}
        {% if missing_data %}
        <button type="button" class="btn" style="background: #059669;" onclick="reExtractMissing()">
            üîÑ Re-extract Missing
        </button>
        {% endif %}
    </div>
    
    {% if search or current_source or current_type or current_category or current_tags or missing_data %}
    <div style="padding: 0.75rem 1rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; margin-bottom: 1rem;">
        <strong>Active filters:</strong>
        {% if search %}
            <span class="badge" style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; margin-left: 0.5rem;">
                Search: "{{ search }}"
            </span>
        {% endif %}
        {% if current_type %}
            <span class="badge" style="background: #8b5cf6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; margin-left: 0.5rem;">
                Type: {{ current_type }}
            </span>
        {% endif %}
        {% if current_category %}
            <span class="badge" style="background: #ec4899; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; margin-left: 0.5rem;">
                Category: {{ current_category }}
            </span>
        {% endif %}
        {% for tag in current_tags %}
            <span class="badge" style="background: #06b6d4; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; margin-left: 0.5rem;">
                Tag: {{ tag }}
            </span>
        {% endfor %}
        {% if missing_data %}
            <span class="badge" style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; margin-left: 0.5rem;">
                Missing {{ missing_data|upper }}
            </span>
        {% endif %}
        <a href="/models" style="margin-left: 1rem; color: #2563eb;">Clear all filters</a>
    </div>
    {% endif %}
    
    {% if missing_data %}
    <div style="padding: 0.75rem 1rem; background: #fef3c7; border: 1px solid #fde68a; border-radius: 6px; margin-bottom: 1rem;">
        <strong>Filtered by:</strong> 
        <span class="badge" style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
            Missing {{ missing_data|upper }}
        </span>
        <a href="/models" style="margin-left: 1rem; color: #2563eb;">Clear filter</a>
    </div>
    {% endif %}
    
    {% if models %}
        <p style="color: #6b7280; margin-bottom: 1rem;">Showing {{ models|length }} models</p>
        
        <!-- Detailed View (default) -->
        <div id="detailedView" style="display: block;">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Cost per Call</th>
                    <th>Credits</th>
                    <th>Data Status</th>
                    <th>Source</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for model in models %}
                <tr>
                    <td>
                        <strong>{{ model.name }}</strong>
                        {% if model.description %}
                            <br><small style="color: #6b7280;">{{ model.description[:80] }}{% if model.description|length > 80 %}...{% endif %}</small>
                        {% endif %}
                        {% if model.parsed_version or model.parsed_company or model.parsed_size %}
                            <br>
                            <div style="margin-top: 0.25rem; font-size: 0.8rem; color: #6b7280;">
                                {% if model.parsed_company %}<span style="color: #3b82f6;">{{ model.parsed_company }}</span>{% endif %}
                                {% if model.parsed_model_family %}<span style="margin-left: 0.25rem;">{{ model.parsed_model_family }}</span>{% endif %}
                                {% if model.parsed_version %}<span style="margin-left: 0.25rem; font-weight: 600; color: #2563eb;">v{{ model.parsed_version }}</span>{% endif %}
                                {% if model.parsed_size %}<span style="margin-left: 0.25rem; font-weight: 600;">{{ model.parsed_size }}</span>{% endif %}
                            </div>
                        {% endif %}
                    </td>
                    <td><span class="badge badge-blue">{{ model.model_type }}</span></td>
                    <td>
                        {% if model.cost_per_call and model.cost_per_call > 0 %}
                            <strong>${{ "%.4f"|format(model.cost_per_call) }}</strong>
                        {% else %}
                            <span style="color: #dc2626;">Missing</span>
                        {% endif %}
                    </td>
                    <td>{{ model.credits_required if model.credits_required else '-' }}</td>
                    <td>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            {% if model.llm_extracted %}
                                <span class="badge" style="background: #059669;">LLM</span>
                            {% endif %}
                            {% if model.input_schema or model.output_schema %}
                                <span class="badge" style="background: #2563eb;">Schema</span>
                            {% endif %}
                            {% if model.raw_metadata %}
                                <span class="badge" style="background: #7c3aed;">Raw</span>
                            {% endif %}
                            {% if not model.llm_extracted and not (model.input_schema or model.output_schema) and not model.raw_metadata %}
                                <span style="color: #dc2626; font-size: 0.875rem;">No data</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ model.source.name }}</td>
                    <td>
                        <a href="/models/{{ model.id }}" class="btn btn-small">View</a>
                        <button class="btn btn-small" style="background: #3b82f6;" onclick="showEditModal({{ model.id }})">‚úèÔ∏è</button>
                        <button class="btn btn-small" style="background: #f59e0b;" onclick="refetchSingleModel({{ model.id }}, event)">üîÑ</button>
                        <button class="btn btn-small btn-danger" onclick="deleteModel({{ model.id }}, '{{ model.name|replace("'", "\\'") }}')">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        
        <!-- Simple View -->
        <div id="simpleView" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>Model Name</th>
                    <th>Model ID</th>
                    <th>Company</th>
                    <th>Family</th>
                    <th>Version</th>
                    <th>Size</th>
                    <th>Cost per Call</th>
                </tr>
            </thead>
            <tbody>
                {% for model in models %}
                <tr>
                    <td>{{ model.name }}</td>
                    <td><code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">{{ model.model_id }}</code></td>
                    <td>{{ model.parsed_company or '-' }}</td>
                    <td>{{ model.parsed_model_family or '-' }}</td>
                    <td>{{ model.parsed_version or '-' }}</td>
                    <td>{{ model.parsed_size or '-' }}</td>
                    <td>
                        {% if model.cost_per_call and model.cost_per_call > 0 %}
                            <strong>${{ "%.4f"|format(model.cost_per_call) }}</strong>
                        {% else %}
                            <span style="color: #dc2626;">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    {% else %}
        <div class="empty-state">
            <h3>No models found</h3>
            <p>Try adjusting your filters or extract data from a source.</p>
        </div>
    {% endif %}
</div>

<!-- Re-extraction Progress Modal -->
<div id="reExtractModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 style="margin: 0 0 1rem 0;">Re-extracting Missing Data</h3>
        <div id="reExtractProgress" style="margin-bottom: 1rem;">
            <div style="font-size: 2rem; font-weight: bold; text-align: center; margin-bottom: 0.5rem;">
                <span id="reExtractProcessed">0</span> / <span id="reExtractTotal">0</span>
            </div>
            <div style="background: #e5e7eb; height: 24px; border-radius: 12px; overflow: hidden;">
                <div id="reExtractBar" style="background: linear-gradient(90deg, #3b82f6, #2563eb); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <div style="text-align: center; margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                <span id="reExtractStatus">Preparing...</span>
            </div>
        </div>
        <div id="reExtractResults" style="display: none;">
            <div style="padding: 1rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; margin-bottom: 1rem;">
                <strong style="color: #059669;">‚úì Re-extraction Complete</strong>
                <div style="margin-top: 0.5rem; color: #065f46;">
                    Updated <span id="reExtractUpdated">0</span> models
                </div>
            </div>
            <button onclick="closeReExtractModal()" class="btn" style="width: 100%;">Close</button>
        </div>
    </div>
</div>

<!-- Edit Model Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin: 0 0 1.5rem 0;">‚úèÔ∏è Edit Model</h3>
        <form id="editForm" onsubmit="saveModel(event)">
            <input type="hidden" id="editModelId">
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Model ID *</label>
                <input type="text" id="editModelId_field" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">Unique identifier from provider</small>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Name *</label>
                <input type="text" id="editName" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Description</label>
                <textarea id="editDescription" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Model Type *</label>
                <select id="editModelType" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">Select type...</option>
                    <option value="text-generation">text-generation</option>
                    <option value="image-generation">image-generation</option>
                    <option value="video-generation">video-generation</option>
                    <option value="audio-generation">audio-generation</option>
                    <option value="3d-generation">3d-generation</option>
                    <option value="embeddings">embeddings</option>
                    <option value="code-generation">code-generation</option>
                    <option value="reranking">reranking</option>
                    <option value="moderation">moderation</option>
                    <option value="search">search</option>
                    <option value="training">training</option>
                    <option value="detection">detection</option>
                    <option value="other">other</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Category</label>
                <input type="text" id="editCategory" placeholder="e.g., text-to-image, image-to-video" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">Specific type (not validated)</small>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Cost per Call ($)</label>
                    <input type="number" id="editCostPerCall" step="0.0001" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Cost per 1K Tokens ($)</label>
                    <input type="number" id="editCostPer1kTokens" step="0.0001" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Credits Required</label>
                <input type="number" id="editCreditsRequired" step="0.01" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Pricing Formula</label>
                <textarea id="editPricingFormula" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Tags (comma-separated)</label>
                <input type="text" id="editTags" placeholder="image, ai, generation" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn" style="flex: 1; background: #10b981;">üíæ Save Changes</button>
                <button type="button" onclick="closeEditModal()" class="btn" style="flex: 1; background: #6b7280;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Model Modal -->
<div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin: 0 0 1.5rem 0;">‚ûï Create New Model</h3>
        <form id="createForm" onsubmit="createModel(event)">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Source *</label>
                <select id="createSource" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">Select source...</option>
                    {% for source in sources %}
                    <option value="{{ source.id }}">{{ source.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Model ID *</label>
                <input type="text" id="createModelId" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">Unique identifier from provider</small>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Name *</label>
                <input type="text" id="createName" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Description</label>
                <textarea id="createDescription" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Model Type *</label>
                <select id="createModelType" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">Select type...</option>
                    <option value="text-generation">text-generation</option>
                    <option value="image-generation">image-generation</option>
                    <option value="video-generation">video-generation</option>
                    <option value="audio-generation">audio-generation</option>
                    <option value="3d-generation">3d-generation</option>
                    <option value="embeddings">embeddings</option>
                    <option value="code-generation">code-generation</option>
                    <option value="reranking">reranking</option>
                    <option value="moderation">moderation</option>
                    <option value="search">search</option>
                    <option value="training">training</option>
                    <option value="detection">detection</option>
                    <option value="other">other</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Category</label>
                <input type="text" id="createCategory" placeholder="e.g., text-to-image, image-to-video" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">Specific type (not validated)</small>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Cost per Call ($)</label>
                    <input type="number" id="createCostPerCall" step="0.0001" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Cost per 1K Tokens ($)</label>
                    <input type="number" id="createCostPer1kTokens" step="0.0001" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Credits Required</label>
                <input type="number" id="createCreditsRequired" step="0.01" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Pricing Formula</label>
                <textarea id="createPricingFormula" rows="2" placeholder="e.g., $0.001 per image" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Tags (comma-separated)</label>
                <input type="text" id="createTags" placeholder="image, ai, generation" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn" style="flex: 1; background: #10b981;">‚ûï Create Model</button>
                <button type="button" onclick="closeCreateModal()" class="btn" style="flex: 1; background: #6b7280;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- LLM Extraction Modal -->
<div id="llmExtractionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
        <h3 style="margin: 0 0 1rem 0;">ü§ñ Run LLM Extraction</h3>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">
            Use AI to analyze models and fix their types, categories, tags, and pricing information.
        </p>
        
        <form id="llmExtractionForm" onsubmit="runLLMExtraction(event)">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Filter by Source (optional)</label>
                <select id="llmSourceFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">All Sources</option>
                    {% for source in sources %}
                        <option value="{{ source.id }}">{{ source.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Filter by Type (optional)</label>
                <select id="llmTypeFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">All Types</option>
                    <option value="text-generation">text-generation</option>
                    <option value="image-generation">image-generation</option>
                    <option value="video-generation">video-generation</option>
                    <option value="audio-generation">audio-generation</option>
                    <option value="3d-generation">3d-generation</option>
                    <option value="embeddings">embeddings</option>
                    <option value="code-generation">code-generation</option>
                    <option value="reranking">reranking</option>
                    <option value="moderation">moderation</option>
                    <option value="search">search</option>
                    <option value="training">training</option>
                    <option value="detection">detection</option>
                    <option value="other">other</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Filter by Missing Data</label>
                <select id="llmMissingFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">All Models</option>
                    <option value="llm">Only Missing LLM Data</option>
                </select>
            </div>
            
            <div style="padding: 1rem; background: #fef3c7; border: 1px solid #fde68a; border-radius: 6px; margin-bottom: 1.5rem;">
                <strong style="color: #92400e;">‚ö†Ô∏è Note:</strong>
                <p style="color: #92400e; margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                    This process uses AI (LLM) to analyze and update model metadata. It may take several minutes depending on the number of models.
                </p>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn" style="flex: 1; background: #8b5cf6;">üöÄ Start Extraction</button>
                <button type="button" onclick="closeLLMExtractionModal()" class="btn" style="flex: 1; background: #6b7280;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- LLM Extraction Progress Modal -->
<div id="llmProgressModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 style="margin: 0 0 1.5rem 0;">ü§ñ LLM Extraction in Progress</h3>
        
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;">Progress</span>
                <span id="llmProgressText">0/0 models</span>
            </div>
            <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                <div id="llmProgressBar" style="background: linear-gradient(90deg, #8b5cf6, #6d28d9); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Currently processing:</div>
            <div id="llmCurrentModel" style="font-weight: 600; color: #111827; margin-bottom: 1rem;">Starting...</div>
            
            <!-- Model Changes Display -->
            <div id="llmModelChanges" style="display: none; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 0.875rem;">
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center;">
                    <div>
                        <div style="color: #6b7280; font-size: 0.75rem; margin-bottom: 0.25rem;">Current Type</div>
                        <div id="llmCurrentType" style="font-weight: 600; color: #dc2626;">-</div>
                    </div>
                    <div style="color: #6b7280; font-size: 1.25rem;">‚Üí</div>
                    <div>
                        <div style="color: #6b7280; font-size: 0.75rem; margin-bottom: 0.25rem;">LLM Extracted</div>
                        <div id="llmExtractedType" style="font-weight: 600; color: #10b981;">-</div>
                    </div>
                </div>
                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                    <div style="color: #6b7280; font-size: 0.75rem; margin-bottom: 0.25rem;">Category & Tags</div>
                    <div id="llmExtractedDetails" style="color: #374151; font-size: 0.8rem;">-</div>
                </div>
            </div>
        </div>
        
        <div id="llmProgressStatus"></div>
        
        <button onclick="closeLLMProgressModal()" class="btn" style="width: 100%; background: #6b7280; margin-top: 1rem;">
            Close & Refresh
        </button>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Initialize tags display on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTagsDisplay();
});

function showEditModal(modelId) {
    // Fetch model data
    fetch(`/api/ai-models/${modelId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editModelId').value = data.id;
            document.getElementById('editModelId_field').value = data.model_id || '';
            document.getElementById('editName').value = data.name || '';
            document.getElementById('editDescription').value = data.description || '';
            document.getElementById('editModelType').value = data.model_type || '';
            document.getElementById('editCategory').value = data.category || '';
            document.getElementById('editCostPerCall').value = data.cost_per_call || '';
            document.getElementById('editCostPer1kTokens').value = data.cost_per_1k_tokens || '';
            document.getElementById('editCreditsRequired').value = data.credits_required || '';
            document.getElementById('editPricingFormula').value = data.pricing_formula || '';
            document.getElementById('editTags').value = (data.tags || []).join(', ');
            
            document.getElementById('editModal').style.display = 'flex';
        })
        .catch(error => {
            alert('Error loading model: ' + error);
        });
}

function showCreateModal() {
    document.getElementById('createForm').reset();
    document.getElementById('createModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
}

function createModel(event) {
    event.preventDefault();
    
    const tagsInput = document.getElementById('createTags').value;
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    const data = {
        source_id: parseInt(document.getElementById('createSource').value),
        model_id: document.getElementById('createModelId').value,
        name: document.getElementById('createName').value,
        description: document.getElementById('createDescription').value,
        model_type: document.getElementById('createModelType').value,
        category: document.getElementById('createCategory').value,
        cost_per_call: document.getElementById('createCostPerCall').value || null,
        cost_per_1k_tokens: document.getElementById('createCostPer1kTokens').value || null,
        credits_required: document.getElementById('createCreditsRequired').value || null,
        pricing_formula: document.getElementById('createPricingFormula').value,
        tags: tags
    };
    
    fetch('/api/ai-models', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úì Model created successfully!');
            closeCreateModal();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function saveModel(event) {
    event.preventDefault();
    
    const modelId = document.getElementById('editModelId').value;
    const tagsInput = document.getElementById('editTags').value;
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    const data = {
        name: document.getElementById('editName').value,
        description: document.getElementById('editDescription').value,
        model_type: document.getElementById('editModelType').value,
        category: document.getElementById('editCategory').value,
        cost_per_call: document.getElementById('editCostPerCall').value || null,
        cost_per_1k_tokens: document.getElementById('editCostPer1kTokens').value || null,
        credits_required: document.getElementById('editCreditsRequired').value || null,
        pricing_formula: document.getElementById('editPricingFormula').value,
        tags: tags
    };
    
    fetch(`/api/ai-models/${modelId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úì Model updated successfully!');
            closeEditModal();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function deleteModel(modelId, modelName) {
    if (!confirm(`Delete model "${modelName}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    fetch(`/api/ai-models/${modelId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì Model deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function updateTagsDisplay() {
    const select = document.getElementById('tagsSelect');
    const display = document.getElementById('tagsDisplay');
    const hiddenContainer = document.getElementById('tagsHiddenInputs');
    const selected = Array.from(select.selectedOptions).map(opt => opt.value);
    
    // Update display text
    if (selected.length === 0) {
        display.textContent = 'All Tags';
        display.style.color = '#6b7280';
    } else if (selected.length === 1) {
        display.textContent = selected[0];
        display.style.color = '#111827';
    } else {
        display.textContent = `${selected.length} tags selected`;
        display.style.color = '#111827';
    }
    
    // Update hidden inputs for form submission
    hiddenContainer.innerHTML = '';
    selected.forEach(tag => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tags';
        input.value = tag;
        hiddenContainer.appendChild(input);
    });
}

function filterMissingData(type) {
    const form = document.getElementById('filterForm');
    const missingDataSelect = document.getElementById('missingDataFilter');
    missingDataSelect.value = type;
    form.submit();
}

function showDeleteAllDialog() {
    const sourceFilter = document.getElementById('sourceFilter');
    const sourceId = sourceFilter.value;
    const sourceName = sourceFilter.options[sourceFilter.selectedIndex].text;
    
    if (!sourceId) {
        alert('Please select a source first to delete all models from that source.');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ALL models from ${sourceName}?\n\nThis action cannot be undone!`)) {
        return;
    }
    
    fetch(`/sources/${sourceId}/models/delete-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function showRemoveDuplicatesDialog() {
    const sourceFilter = document.getElementById('sourceFilter');
    const sourceId = sourceFilter.value;
    const sourceName = sourceFilter.options[sourceFilter.selectedIndex].text;
    
    if (!sourceId) {
        alert('Please select a source first to remove duplicates from that source.');
        return;
    }
    
    if (!confirm(`Find and remove duplicate models from ${sourceName}?\n\nThis will keep the newest version of each model and delete older duplicates.\n\nThis action cannot be undone!`)) {
        return;
    }
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Processing...';
    
    fetch(`/sources/${sourceId}/models/remove-duplicates`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            if (data.deleted_count === 0) {
                alert('‚úì No duplicates found!');
            } else {
                const details = data.details && data.details.length > 0 
                    ? '\n\nDuplicates removed:\n' + data.details.map(d => `  ‚Ä¢ ${d.model_id}: kept "${d.kept}", deleted ${d.deleted} duplicate(s)`).join('\n')
                    : '';
                alert(`‚úì ${data.message}${details}`);
                location.reload();
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('Error: ' + error);
    });
}

function reExtractMissing() {
    const sourceFilter = document.getElementById('sourceFilter');
    const sourceId = sourceFilter.value;
    const missingType = document.getElementById('missingDataFilter').value;
    
    if (!sourceId) {
        alert('Please select a source first.');
        return;
    }
    
    if (!missingType) {
        alert('Please select a missing data type filter first.');
        return;
    }
    
    const modal = document.getElementById('reExtractModal');
    modal.style.display = 'flex';
    document.getElementById('reExtractResults').style.display = 'none';
    document.getElementById('reExtractProgress').style.display = 'block';
    
    fetch(`/sources/${sourceId}/re-extract?missing_type=${missingType}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Start polling for progress
            pollReExtractProgress(sourceId);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            closeReExtractModal();
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        closeReExtractModal();
    });
}

function pollReExtractProgress(sourceId) {
    const interval = setInterval(() => {
        fetch(`/api/re-extract-progress/${sourceId}`)
            .then(response => response.json())
            .then(data => {
                updateReExtractProgress(data);
                
                if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(interval);
                    showReExtractResults(data);
                }
            })
            .catch(error => {
                console.error('Error polling progress:', error);
                clearInterval(interval);
            });
    }, 1000);
}

function updateReExtractProgress(data) {
    document.getElementById('reExtractProcessed').textContent = data.processed || 0;
    document.getElementById('reExtractTotal').textContent = data.total || 0;
    
    const percent = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
    document.getElementById('reExtractBar').style.width = percent + '%';
    
    if (data.current_model) {
        document.getElementById('reExtractStatus').textContent = `Processing: ${data.current_model}`;
    }
}

function showReExtractResults(data) {
    document.getElementById('reExtractProgress').style.display = 'none';
    document.getElementById('reExtractResults').style.display = 'block';
    document.getElementById('reExtractUpdated').textContent = data.updated || 0;
}

function closeReExtractModal() {
    document.getElementById('reExtractModal').style.display = 'none';
    location.reload();
}

function refetchSingleModel(modelId, event) {
    event.preventDefault();
    
    if (!confirm('Re-fetch data for this model?')) {
        return;
    }
    
    fetch(`/models/${modelId}/refetch`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì Model re-fetched successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function refetchFiltered() {
    const searchInput = document.querySelector('input[name="search"]');
    const sourceSelect = document.querySelector('select[name="source_id"]');
    const typeSelect = document.querySelector('select[name="type"]');
    const missingDataSelect = document.querySelector('select[name="missing_data"]');
    
    const filters = {};
    if (searchInput && searchInput.value) filters.search = searchInput.value;
    if (sourceSelect && sourceSelect.value) filters.source_id = sourceSelect.value;
    if (typeSelect && typeSelect.value) filters.type = typeSelect.value;
    if (missingDataSelect && missingDataSelect.value) filters.missing_data = missingDataSelect.value;
    
    if (Object.keys(filters).length === 0) {
        alert('Please apply some filters first.');
        return;
    }
    
    if (!confirm(`Re-fetch data for all filtered models? This may take a while.`)) {
        return;
    }
    
    const queryString = new URLSearchParams(filters).toString();
    
    fetch(`/models/refetch-filtered?${queryString}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úì Re-fetched ${data.count} models successfully!`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// LLM Extraction Modal Functions
function showLLMExtractionModal() {
    document.getElementById('llmExtractionModal').style.display = 'flex';
}

function closeLLMExtractionModal() {
    document.getElementById('llmExtractionModal').style.display = 'none';
}

function runLLMExtraction(event) {
    event.preventDefault();
    
    const sourceId = document.getElementById('llmSourceFilter').value;
    const modelType = document.getElementById('llmTypeFilter').value;
    const missingData = document.getElementById('llmMissingFilter').value;
    
    const payload = {};
    if (sourceId) payload.source_id = parseInt(sourceId);
    if (modelType) payload.model_type = modelType;
    if (missingData) payload.missing_data = missingData;
    
    const btn = event.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Starting...';
    
    fetch('/api/run-llm-extraction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeLLMExtractionModal();
            showLLMProgressModal(data.total);
        } else {
            alert('Error: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function showLLMProgressModal(total) {
    const modal = document.getElementById('llmProgressModal');
    modal.style.display = 'flex';
    
    const progressInterval = setInterval(() => {
        fetch('/api/llm-extraction-progress')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    clearInterval(progressInterval);
                    document.getElementById('llmProgressStatus').innerHTML = 
                        '<div style="color: #dc2626;">‚ùå ' + data.error + '</div>';
                    return;
                }
                
                const percent = Math.round((data.processed_models / data.total_models) * 100);
                document.getElementById('llmProgressBar').style.width = percent + '%';
                document.getElementById('llmProgressText').textContent = 
                    `${data.processed_models}/${data.total_models} models (${data.updated_models} updated)`;
                document.getElementById('llmCurrentModel').textContent = 
                    data.current_model_name || 'Processing...';
                
                // Show extraction changes if available
                if (data.current_extraction) {
                    const changesDiv = document.getElementById('llmModelChanges');
                    changesDiv.style.display = 'block';
                    
                    const ext = data.current_extraction;
                    document.getElementById('llmCurrentType').textContent = ext.original_type || 'none';
                    document.getElementById('llmExtractedType').textContent = ext.extracted_type || 'none';
                    
                    let details = [];
                    if (ext.extracted_category) {
                        details.push(`Category: ${ext.extracted_category}`);
                    }
                    if (ext.extracted_tags && ext.extracted_tags.length > 0) {
                        details.push(`Tags: ${ext.extracted_tags.join(', ')}`);
                    }
                    document.getElementById('llmExtractedDetails').textContent = 
                        details.length > 0 ? details.join(' | ') : 'No additional details';
                } else {
                    document.getElementById('llmModelChanges').style.display = 'none';
                }
                
                if (data.status === 'complete') {
                    clearInterval(progressInterval);
                    document.getElementById('llmProgressStatus').innerHTML = 
                        '<div style="color: #10b981;">‚úÖ Completed! Refreshing page...</div>';
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else if (data.status === 'error') {
                    clearInterval(progressInterval);
                    const errorMsg = data.errors && data.errors.length > 0 ? data.errors[data.errors.length - 1].message : 'Unknown error';
                    document.getElementById('llmProgressStatus').innerHTML = 
                        '<div style="color: #dc2626;">‚ùå Failed: ' + errorMsg + '</div>';
                }
            })
            .catch(error => {
                console.error('Progress check failed:', error);
            });
    }, 1000);
}

function closeLLMProgressModal() {
    document.getElementById('llmProgressModal').style.display = 'none';
    location.reload();
}

function toggleViewMode() {
    const detailedView = document.getElementById('detailedView');
    const simpleView = document.getElementById('simpleView');
    
    if (detailedView.style.display === 'none') {
        // Switch to detailed view
        detailedView.style.display = 'block';
        simpleView.style.display = 'none';
    } else {
        // Switch to simple view
        detailedView.style.display = 'none';
        simpleView.style.display = 'block';
    }
}
</script>
{% endblock %}
