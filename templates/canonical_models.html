{% extends "base.html" %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h2 style="margin: 0 0 0.5rem 0;">üîÑ Unified Model View</h2>
            <p style="color: #6b7280; margin: 0;">Compare the same models across different providers</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="window.location.href='/models'" class="btn" style="background: #6b7280;">
                üìã By Provider View
            </button>
            <button id="runMatchingBtn" onclick="runModelMatching()" class="btn" style="background: #10b981;">
                ü§ñ Run Model Matching
            </button>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div style="margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center;">
        <label for="typeFilter" style="font-weight: 600;">Filter by Type:</label>
        <select id="typeFilter" onchange="filterByType()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db;">
            <option value="">All Types</option>
            <option value="image">Image</option>
            <option value="text">Text (LLM)</option>
            <option value="video">Video</option>
            <option value="audio">Audio</option>
            <option value="other">Other</option>
        </select>
        
        <div style="margin-left: auto;">
            <span id="modelCount" style="color: #6b7280; font-size: 0.9rem;"></span>
        </div>
    </div>
    
    <!-- Loading State -->
    <div id="loading" style="text-align: center; padding: 3rem;">
        <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
        <p style="color: #6b7280;">Loading unified models...</p>
    </div>
    
    <!-- Error State -->
    <div id="error" style="display: none; padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b; margin-bottom: 1rem;"></div>
    
    <!-- No Results State -->
    <div id="noResults" style="display: none; text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
        <h3 style="color: #6b7280; margin-bottom: 0.5rem;">No Matched Models Found</h3>
        <p style="color: #9ca3af; margin-bottom: 1.5rem;">Run model matching to identify equivalent models across providers</p>
        <button onclick="runModelMatching()" class="btn" style="background: #10b981;">
            ü§ñ Run Model Matching Now
        </button>
    </div>
    
    <!-- Models Grid -->
    <div id="modelsGrid" style="display: none;"></div>
</div>

<script>
let allModels = [];
let currentPage = 1;
let totalPages = 1;
const perPage = 20;

// Load canonical models on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCanonicalModels();
});

function loadCanonicalModels(modelType = '', page = 1) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const noResults = document.getElementById('noResults');
    const grid = document.getElementById('modelsGrid');
    
    loading.style.display = 'block';
    error.style.display = 'none';
    noResults.style.display = 'none';
    grid.style.display = 'none';
    
    const url = `/api/canonical-models?page=${page}&per_page=${perPage}${modelType ? `&model_type=${modelType}` : ''}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.error) {
                error.textContent = data.error;
                error.style.display = 'block';
                return;
            }
            
            allModels = data.models || [];
            currentPage = data.page || 1;
            totalPages = data.total_pages || 1;
            
            if (allModels.length === 0) {
                noResults.style.display = 'block';
                return;
            }
            
            renderModels(allModels, data.total);
        })
        .catch(err => {
            loading.style.display = 'none';
            error.textContent = 'Failed to load models: ' + err.message;
            error.style.display = 'block';
        });
}

function renderModels(models, total) {
    const grid = document.getElementById('modelsGrid');
    const count = document.getElementById('modelCount');
    
    const start = (currentPage - 1) * perPage + 1;
    const end = Math.min(currentPage * perPage, total);
    count.textContent = `Showing ${start}-${end} of ${total} unique model${total !== 1 ? 's' : ''}`;
    
    let html = '<div style="display: grid; gap: 1rem;">';
    
    models.forEach(model => {
        const bestPrice = model.best_price;
        const priceDisplay = bestPrice ? `$${bestPrice.cost_per_call.toFixed(6)}` : 'N/A';
        
        html += `
            <div class="card" style="border: 1px solid #e5e7eb; padding: 0; overflow: hidden;">
                <!-- Compact Header -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0; font-size: 1.1rem;">${model.display_name}</h3>
                            <div style="display: flex; gap: 1rem; align-items: center; font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">
                                <span>üì¶ ${model.provider_count} provider${model.provider_count !== 1 ? 's' : ''}</span>
                                <span class="badge" style="background: rgba(255,255,255,0.2); padding: 0.15rem 0.5rem;">${model.model_type || 'unknown'}</span>
                            </div>
                        </div>
                        ${bestPrice ? `
                            <div style="text-align: right; background: rgba(255,255,255,0.15); padding: 0.5rem 1rem; border-radius: 6px;">
                                <p style="margin: 0; font-size: 0.75rem; opacity: 0.9;">Best Price</p>
                                <p style="margin: 0; font-size: 1.25rem; font-weight: 700;">${priceDisplay}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Compact Content -->
                <div style="padding: 1rem;">
                    <!-- Providers (Compact Table) -->
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Provider</th>
                                    <th style="text-align: right; padding: 0.5rem; color: #6b7280;">Price/Call</th>
                                    <th style="text-align: center; padding: 0.5rem; color: #6b7280;">Confidence</th>
                                    <th style="text-align: right; padding: 0.5rem;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${model.providers.slice(0, 5).map((provider, index) => {
                                    const isBest = index === 0 && provider.cost_per_call;
                                    return `
                                        <tr style="border-bottom: 1px solid #f3f4f6; ${isBest ? 'background: #f0fdf4;' : ''}">
                                            <td style="padding: 0.5rem; font-weight: 500;">
                                                ${provider.provider}
                                                ${isBest ? '<span style="color: #10b981; margin-left: 0.25rem;">‚úì</span>' : ''}
                                            </td>
                                            <td style="padding: 0.5rem; text-align: right; font-weight: 600; color: ${isBest ? '#10b981' : '#2563eb'};">
                                                $${provider.cost_per_call ? provider.cost_per_call.toFixed(6) : 'N/A'}
                                            </td>
                                            <td style="padding: 0.5rem; text-align: center; color: #6b7280;">
                                                ${(provider.confidence * 100).toFixed(0)}%
                                            </td>
                                            <td style="padding: 0.5rem; text-align: right;">
                                                <a href="/models/${provider.model_id}" class="btn-sm">View</a>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                                ${model.provider_count > 5 ? `
                                    <tr>
                                        <td colspan="4" style="padding: 0.5rem; text-align: center; color: #6b7280; font-size: 0.85rem;">
                                            + ${model.provider_count - 5} more provider${model.provider_count - 5 !== 1 ? 's' : ''}
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Add pagination
    if (totalPages > 1) {
        html += `
            <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem; padding: 1rem;">
                <button onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''} 
                        class="btn" style="padding: 0.5rem 1rem;">
                    ‚Üê Previous
                </button>
                <span style="color: #6b7280;">
                    Page ${currentPage} of ${totalPages}
                </span>
                <button onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''} 
                        class="btn" style="padding: 0.5rem 1rem;">
                    Next ‚Üí
                </button>
            </div>
        `;
    }
    
    grid.innerHTML = html;
    grid.style.display = 'block';
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    const select = document.getElementById('typeFilter');
    const selectedType = select.value;
    loadCanonicalModels(selectedType, page);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function filterByType() {
    const select = document.getElementById('typeFilter');
    const selectedType = select.value;
    
    loadCanonicalModels(selectedType, 1);
}

function runModelMatching() {
    const btn = document.getElementById('runMatchingBtn');
    const originalText = btn.innerHTML;
    
    if (!confirm('Run model matching across all providers? This will use AI to identify equivalent models.')) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Matching...';
    
    fetch('/api/match-models', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ force_refresh: false })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else if (data.status === 'already_matched') {
            if (confirm(`Models are already matched (${data.existing_matches} matches). Re-match anyway?`)) {
                // Re-run with force refresh
                return fetch('/api/match-models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ force_refresh: true })
                }).then(response => response.json());
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                return null;
            }
        } else {
            return data;
        }
    })
    .then(data => {
        if (data) {
            alert(`‚úì Model matching complete!\n\nCanonical Models: ${data.canonical_models_created}\nMatches Created: ${data.model_matches_created}\nModels Processed: ${data.total_models_processed}`);
            loadCanonicalModels();
        }
        btn.disabled = false;
        btn.innerHTML = originalText;
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}
</script>

<style>
.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-gray {
    background: #f3f4f6;
    color: #374151;
}

.btn {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    background: #1d4ed8;
}

.btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.btn-sm {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.35rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    font-size: 0.85rem;
}

.btn-sm:hover {
    background: #1d4ed8;
}

table {
    border-collapse: collapse;
}

tbody tr:hover {
    background: #f9fafb !important;
}
</style>
{% endblock %}
