{% extends "base.html" %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h2 style="margin: 0 0 0.5rem 0;">üîÑ Unified Model View</h2>
            <p style="color: #6b7280; margin: 0;">Compare the same models across different providers</p>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button onclick="window.location.href='/models'" class="btn" style="background: #6b7280;">
                üìã By Provider View
            </button>
            <button onclick="showCreateCanonicalModal()" class="btn" style="background: #10b981;">
                ‚ûï Create New
            </button>
            <select id="matchTypeSelector" style="padding: 0.5rem 1rem; border-radius: 4px; border: 1px solid #d1d5db; background: white;">
                <option value="">All Types</option>
                <option value="text-generation">Text Generation</option>
                <option value="image-generation">Image Generation</option>
                <option value="video-generation">Video Generation</option>
                <option value="audio-generation">Audio Generation</option>
                <option value="embeddings">Embeddings</option>
                <option value="reranking">Reranking</option>
                <option value="model-3d">3D Models</option>
                <option value="moderation">Moderation</option>
                <option value="search">Search</option>
                <option value="training">Training</option>
                <option value="detection">Detection</option>
                <option value="other">Other</option>
            </select>
            <button id="runMatchingBtn" onclick="runModelMatching()" class="btn" style="background: #10b981;">
                ü§ñ Match Models
            </button>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div style="margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center;">
        <label for="typeFilter" style="font-weight: 600;">Filter by Type:</label>
        <select id="typeFilter" onchange="filterByType()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db;">
            <option value="">All Types</option>
            <option value="text-generation">Text Generation</option>
            <option value="image-generation">Image Generation</option>
            <option value="video-generation">Video Generation</option>
            <option value="audio-generation">Audio Generation</option>
            <option value="model-3d">3D Models</option>
            <option value="embeddings">Embeddings</option>
            <option value="code-generation">Code Generation</option>
            <option value="reranking">Reranking</option>
            <option value="moderation">Moderation</option>
            <option value="search">Search</option>
            <option value="training">Training</option>
            <option value="detection">Detection</option>
            <option value="other">Other</option>
        </select>
        
        <div style="margin-left: auto;">
            <span id="modelCount" style="color: #6b7280; font-size: 0.9rem;"></span>
        </div>
    </div>
    
    <!-- Loading State -->
    <div id="loading" style="text-align: center; padding: 3rem;">
        <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
        <p style="color: #6b7280;">Loading unified models...</p>
    </div>
    
    <!-- Error State -->
    <div id="error" style="display: none; padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b; margin-bottom: 1rem;"></div>
    
    <!-- No Results State -->
    <div id="noResults" style="display: none; text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
        <h3 style="color: #6b7280; margin-bottom: 0.5rem;">No Matched Models Found</h3>
        <p style="color: #9ca3af; margin-bottom: 1.5rem;">Run model matching to identify equivalent models across providers</p>
        <button onclick="runModelMatching()" class="btn" style="background: #10b981;">
            ü§ñ Run Model Matching Now
        </button>
    </div>
    
    <!-- Models Grid -->
    <div id="modelsGrid" style="display: none;"></div>
</div>

<!-- Edit Canonical Model Modal -->
<div id="editCanonicalModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin: 0 0 1.5rem 0;">‚úèÔ∏è Edit Unified Model</h3>
        <form id="editCanonicalForm" onsubmit="saveCanonicalModel(event)">
            <input type="hidden" id="editCanonicalId">
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Canonical Name *</label>
                <input type="text" id="editCanonicalName" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">Internal identifier (e.g., flux-dev-1.0)</small>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Display Name *</label>
                <input type="text" id="editDisplayName" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">User-friendly name</small>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Description</label>
                <textarea id="editCanonicalDescription" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Model Type</label>
                <select id="editCanonicalType" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">Select type...</option>
                    <option value="text-generation">text-generation</option>
                    <option value="image-generation">image-generation</option>
                    <option value="video-generation">video-generation</option>
                    <option value="audio-generation">audio-generation</option>
                    <option value="3d-generation">3d-generation</option>
                    <option value="embeddings">embeddings</option>
                    <option value="code-generation">code-generation</option>
                    <option value="reranking">reranking</option>
                    <option value="moderation">moderation</option>
                    <option value="search">search</option>
                    <option value="training">training</option>
                    <option value="detection">detection</option>
                    <option value="other">other</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Tags (comma-separated)</label>
                <input type="text" id="editCanonicalTags" placeholder="image, ai, generation" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn" style="flex: 1; background: #10b981;">üíæ Save Changes</button>
                <button type="button" onclick="closeEditCanonicalModal()" class="btn" style="flex: 1; background: #6b7280;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Model to Canonical Modal -->
<div id="addModelCanonicalModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 style="margin: 0 0 1.5rem 0;">‚ûï Add Model to Unified Model</h3>
        <form id="addModelForm" onsubmit="addModelToCanonical(event)">
            <input type="hidden" id="addModelCanonicalId">
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Select Model *</label>
                <select id="addModelSelect" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">Loading models...</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn" style="flex: 1; background: #10b981;">‚ûï Add Model</button>
                <button type="button" onclick="closeAddModelModal()" class="btn" style="flex: 1; background: #6b7280;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Model Matching Progress Modal -->
<div id="matchingProgressModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">ü§ñ</span>
            <span>Model Matching in Progress</span>
        </h3>
        
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 600; color: #374151;">Overall Progress</span>
                <span id="matchingProgressText" style="font-weight: 600; color: #10b981;">0%</span>
            </div>
            <div style="width: 100%; background: #e5e7eb; border-radius: 8px; overflow: hidden; height: 28px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);">
                <div id="matchingProgressBar" style="width: 0%; background: linear-gradient(90deg, #10b981, #059669); height: 100%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600;"></div>
            </div>
        </div>
        
        <div style="margin-bottom: 1.5rem; background: #f9fafb; padding: 1rem; border-radius: 6px; border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: #6b7280; font-size: 0.9rem;">üìÇ Current Type:</span>
                <span id="matchingCurrentType" style="font-weight: 600; color: #374151;">-</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: #6b7280; font-size: 0.9rem;">üìä Models Processed:</span>
                <span id="matchingModelCount" style="font-weight: 600; color: #374151;">0 / 0</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: #6b7280; font-size: 0.9rem;">üîó Matches Found:</span>
                <span id="matchingMatchCount" style="font-weight: 600; color: #10b981;">0</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280; font-size: 0.9rem;">‚è±Ô∏è Current Batch:</span>
                <span id="matchingBatchInfo" style="font-weight: 600; color: #374151;">-</span>
            </div>
        </div>
        
        <div id="matchingStatusMessage" style="padding: 0.75rem; background: #eff6ff; border-radius: 6px; font-size: 0.9rem; color: #1e40af; text-align: center; border: 1px solid #bfdbfe;">
            Initializing...
        </div>
    </div>
</div>

<!-- Generic Message Modal -->
<div id="messageModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1.5rem;">
            <span id="messageIcon" style="font-size: 2rem;">‚ÑπÔ∏è</span>
            <div style="flex: 1;">
                <h3 id="messageTitle" style="margin: 0 0 0.5rem 0; color: #1f2937;">Message</h3>
                <p id="messageContent" style="margin: 0; color: #6b7280; line-height: 1.5;"></p>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button id="messageCancelBtn" onclick="closeMessageModal(false)" class="btn" style="background: #6b7280; display: none;">Cancel</button>
            <button id="messageOkBtn" onclick="closeMessageModal(true)" class="btn" style="background: #3b82f6;">OK</button>
        </div>
    </div>
</div>

<!-- Suspected Matches Modal -->
<div id="suspectedMatchesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0;">üîç Suspected Matches</h3>
            <button onclick="closeSuspectedMatchesModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
        </div>
        
        <div id="suspectedMatchesContent" style="margin-bottom: 1rem;">
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                Loading suspected matches...
            </div>
        </div>
    </div>
</div>

<!-- Edit Canonical Model Modal -->
<div id="createCanonicalModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin: 0 0 1.5rem 0;">‚ûï Create New Unified Model</h3>
        <form id="createCanonicalForm" onsubmit="createCanonicalModel(event)">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Canonical Name *</label>
                <input type="text" id="createCanonicalName" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">Internal identifier (e.g., flux-dev-1.0)</small>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Display Name *</label>
                <input type="text" id="createDisplayName" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <small style="color: #6b7280;">User-friendly name</small>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Description</label>
                <textarea id="createCanonicalDescription" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Model Type</label>
                <select id="createCanonicalType" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">Select type...</option>
                    <option value="text-generation">text-generation</option>
                    <option value="image-generation">image-generation</option>
                    <option value="video-generation">video-generation</option>
                    <option value="audio-generation">audio-generation</option>
                    <option value="3d-generation">3d-generation</option>
                    <option value="embeddings">embeddings</option>
                    <option value="code-generation">code-generation</option>
                    <option value="reranking">reranking</option>
                    <option value="moderation">moderation</option>
                    <option value="search">search</option>
                    <option value="training">training</option>
                    <option value="detection">detection</option>
                    <option value="other">other</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Tags (comma-separated)</label>
                <input type="text" id="createCanonicalTags" placeholder="image, ai, generation" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn" style="flex: 1; background: #10b981;">‚ûï Create Model</button>
                <button type="button" onclick="closeCreateCanonicalModal()" class="btn" style="flex: 1; background: #6b7280;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
let allModels = [];
let currentPage = 1;
let totalPages = 1;
const perPage = 20;

// Load canonical models on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCanonicalModels();
});

function loadCanonicalModels(modelType = '', page = 1) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const noResults = document.getElementById('noResults');
    const grid = document.getElementById('modelsGrid');
    
    loading.style.display = 'block';
    error.style.display = 'none';
    noResults.style.display = 'none';
    grid.style.display = 'none';
    
    const url = `/api/canonical-models?page=${page}&per_page=${perPage}${modelType ? `&model_type=${modelType}` : ''}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.error) {
                error.textContent = data.error;
                error.style.display = 'block';
                return;
            }
            
            allModels = data.models || [];
            currentPage = data.page || 1;
            totalPages = data.total_pages || 1;
            
            if (allModels.length === 0) {
                noResults.style.display = 'block';
                return;
            }
            
            renderModels(allModels, data.total);
        })
        .catch(err => {
            loading.style.display = 'none';
            error.textContent = 'Failed to load models: ' + err.message;
            error.style.display = 'block';
        });
}

function renderModels(models, total) {
    const grid = document.getElementById('modelsGrid');
    const count = document.getElementById('modelCount');
    
    const start = (currentPage - 1) * perPage + 1;
    const end = Math.min(currentPage * perPage, total);
    count.textContent = `Showing ${start}-${end} of ${total} unique model${total !== 1 ? 's' : ''}`;
    
    let html = '<div style="display: grid; gap: 1rem;">';
    
    models.forEach(model => {
        const bestPrice = model.best_price;
        const priceDisplay = bestPrice ? `$${bestPrice.cost_per_call.toFixed(6)}` : 'N/A';
        
        html += `
            <div class="card" style="border: 1px solid #e5e7eb; padding: 0; overflow: hidden; cursor: pointer;" onclick="window.location.href='/canonical-models/${model.id}'">
                <!-- Compact Header -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0; font-size: 1.1rem;">${model.display_name}</h3>
                            <div style="display: flex; gap: 1rem; align-items: center; font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">
                                <span>üì¶ ${model.provider_count} provider${model.provider_count !== 1 ? 's' : ''}</span>
                                <span class="badge" style="background: rgba(255,255,255,0.2); padding: 0.15rem 0.5rem;">${model.model_type || 'unknown'}</span>
                            </div>
                        </div>
                        ${bestPrice ? `
                            <div style="text-align: right; background: rgba(255,255,255,0.15); padding: 0.5rem 1rem; border-radius: 6px;">
                                <p style="margin: 0; font-size: 0.75rem; opacity: 0.9;">Best Price</p>
                                <p style="margin: 0; font-size: 1.25rem; font-weight: 700;">${priceDisplay}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Compact Content -->
                <div style="padding: 1rem;">
                    ${model.description ? `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-left: 3px solid #667eea; border-radius: 4px;">
                            <p style="margin: 0; font-size: 0.9rem; color: #4b5563; line-height: 1.5;">
                                ${model.description.length > 200 ? model.description.substring(0, 200) + '...' : model.description}
                            </p>
                        </div>
                    ` : ''}
                    
                    ${model.tags && model.tags.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; flex-wrap: wrap; gap: 0.35rem;">
                                ${model.tags.slice(0, 8).map(tag => `
                                    <span class="badge badge-gray" style="font-size: 0.75rem;">${tag}</span>
                                `).join('')}
                                ${model.tags.length > 8 ? `
                                    <span class="badge badge-gray" style="font-size: 0.75rem;">+${model.tags.length - 8} more</span>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Highlights -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; padding: 0.75rem; background: #fffbeb; border-radius: 6px; border: 1px solid #fde68a;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 0.25rem;">üí∞ Best Price</div>
                            <div style="font-weight: 700; color: #b45309; font-size: 1rem;">
                                ${bestPrice ? `$${bestPrice.cost_per_call.toFixed(6)}` : 'N/A'}
                            </div>
                            ${bestPrice ? `<div style="font-size: 0.7rem; color: #92400e; margin-top: 0.15rem;">${bestPrice.provider}</div>` : ''}
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 0.25rem;">üìä Providers</div>
                            <div style="font-weight: 700; color: #b45309; font-size: 1rem;">${model.provider_count}</div>
                            <div style="font-size: 0.7rem; color: #92400e; margin-top: 0.15rem;">available</div>
                        </div>
                        ${model.providers.length > 1 ? `
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 0.25rem;">üíµ Savings</div>
                                <div style="font-weight: 700; color: #059669; font-size: 1rem;">
                                    ${(() => {
                                        const prices = model.providers.map(p => p.cost_per_call).filter(p => p > 0);
                                        if (prices.length < 2) return 'N/A';
                                        const max = Math.max(...prices);
                                        const min = Math.min(...prices);
                                        const savings = ((max - min) / max * 100).toFixed(0);
                                        return `${savings}%`;
                                    })()}
                                </div>
                                <div style="font-size: 0.7rem; color: #92400e; margin-top: 0.15rem;">vs highest</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <button onclick="showEditCanonicalModal(${model.id})" class="btn" style="flex: 1; background: #3b82f6; padding: 0.5rem;">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="showSuspectedMatches(${model.id}, '${model.display_name.replace(/'/g, "\\'")}'); event.stopPropagation();" class="btn" style="flex: 1; background: #f59e0b; padding: 0.5rem;">
                            üîç Find Similar
                        </button>
                        <button onclick="showAddModelModal(${model.id})" class="btn" style="flex: 1; background: #10b981; padding: 0.5rem;">
                            ‚ûï Add Model
                        </button>
                        <button onclick="deleteCanonicalModel(${model.id}, '${model.display_name.replace(/'/g, "\\'")}', ${model.provider_count})" class="btn" style="background: #dc2626; padding: 0.5rem;">
                            üóëÔ∏è
                        </button>
                    </div>
                    
                    <!-- Providers (Compact Table) -->
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Provider</th>
                                    <th style="text-align: right; padding: 0.5rem; color: #6b7280;">Price/Call</th>
                                    <th style="text-align: center; padding: 0.5rem; color: #6b7280;">Confidence</th>
                                    <th style="text-align: right; padding: 0.5rem;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${model.providers.slice(0, 5).map((provider, index) => {
                                    const isBest = index === 0 && provider.cost_per_call;
                                    return `
                                        <tr style="border-bottom: 1px solid #f3f4f6; ${isBest ? 'background: #f0fdf4;' : ''}">
                                            <td style="padding: 0.5rem; font-weight: 500;">
                                                ${provider.provider}
                                                ${isBest ? '<span style="color: #10b981; margin-left: 0.25rem;">‚úì</span>' : ''}
                                            </td>
                                            <td style="padding: 0.5rem; text-align: right; font-weight: 600; color: ${isBest ? '#10b981' : '#2563eb'};">
                                                $${provider.cost_per_call ? provider.cost_per_call.toFixed(6) : 'N/A'}
                                            </td>
                                            <td style="padding: 0.5rem; text-align: center; color: #6b7280;">
                                                ${(provider.confidence * 100).toFixed(0)}%
                                            </td>
                                            <td style="padding: 0.5rem; text-align: right;">
                                                <a href="/models/${provider.model_id}" class="btn-sm">View</a>
                                                <button onclick="removeModelFromCanonical(${model.id}, ${provider.model_id}, '${provider.provider.replace(/'/g, "\\'")}'); event.stopPropagation();" class="btn-sm" style="background: #dc2626; margin-left: 0.25rem;">‚úï</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                                ${model.provider_count > 5 ? `
                                    <tr>
                                        <td colspan="4" style="padding: 0.5rem; text-align: center; color: #6b7280; font-size: 0.85rem;">
                                            + ${model.provider_count - 5} more provider${model.provider_count - 5 !== 1 ? 's' : ''}
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Add pagination
    if (totalPages > 1) {
        html += `
            <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem; padding: 1rem;">
                <button onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''} 
                        class="btn" style="padding: 0.5rem 1rem;">
                    ‚Üê Previous
                </button>
                <span style="color: #6b7280;">
                    Page ${currentPage} of ${totalPages}
                </span>
                <button onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''} 
                        class="btn" style="padding: 0.5rem 1rem;">
                    Next ‚Üí
                </button>
            </div>
        `;
    }
    
    grid.innerHTML = html;
    grid.style.display = 'block';
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    const select = document.getElementById('typeFilter');
    const selectedType = select.value;
    loadCanonicalModels(selectedType, page);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function filterByType() {
    const select = document.getElementById('typeFilter');
    const selectedType = select.value;
    currentPage = 1; // Reset to first page when filtering
    loadCanonicalModels(selectedType, 1);
}

async function runModelMatching() {
    const btn = document.getElementById('runMatchingBtn');
    const originalText = btn.innerHTML;
    const modelType = document.getElementById('matchTypeSelector').value;
    
    // Don't allow multiple concurrent runs
    if (btn.disabled) {
        showMessage('‚ö†Ô∏è', 'Already Running', 'Model matching is already in progress. Please wait for it to complete.');
        return;
    }
    
    // Check if already matched
    try {
        const checkResponse = await fetch('/api/match-models', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ force_refresh: false, model_type: modelType, check_only: true })
        });
        const checkData = await checkResponse.json();
        
        if (checkData.status === 'already_matched') {
            const proceed = await showConfirm(
                'üîÑ',
                'Re-match Models?',
                `Models are already matched (${checkData.existing_matches} matches). Do you want to re-match anyway? This will delete existing matches.`
            );
            if (!proceed) return;
        }
    } catch (error) {
        console.error('Check failed:', error);
    }
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Matching...';
    showMatchingProgressModal();
    
    const typeText = modelType ? ` (${modelType})` : ' (all types)';
    document.getElementById('matchingStatusMessage').textContent = `Starting model matching${typeText}...`;
    
    try {
        const response = await fetch('/api/match-models', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                force_refresh: true,
                model_type: modelType || null
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            closeMatchingProgressModal();
            showMessage('‚ùå', 'Matching Failed', data.error);
        } else {
            closeMatchingProgressModal();
            showMessage(
                '‚úÖ',
                'Matching Complete!',
                `Successfully matched models!\n\n` +
                `üìä Canonical Models: ${data.canonical_models_created}\n` +
                `üîó Matches Created: ${data.model_matches_created}\n` +
                `üìÅ Models Processed: ${data.total_models_processed}\n` +
                `üéØ Match Groups: ${data.match_groups}`
            );
            loadCanonicalModels();
        }
    } catch (error) {
        closeMatchingProgressModal();
        showMessage('‚ùå', 'Error', `Failed to match models: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function showMatchingProgressModal() {
    const modal = document.getElementById('matchingProgressModal');
    modal.style.display = 'flex';
    
    // Reset progress
    document.getElementById('matchingProgressBar').style.width = '0%';
    document.getElementById('matchingProgressText').textContent = '0%';
    document.getElementById('matchingCurrentType').textContent = '-';
    document.getElementById('matchingModelCount').textContent = '0 / 0';
    document.getElementById('matchingMatchCount').textContent = '0';
    document.getElementById('matchingBatchInfo').textContent = '-';
    document.getElementById('matchingStatusMessage').textContent = 'Initializing...';
    
    pollMatchingProgress();
}

function closeMatchingProgressModal() {
    const modal = document.getElementById('matchingProgressModal');
    modal.style.display = 'none';
    clearInterval(window.matchingProgressInterval);
}

function pollMatchingProgress() {
    const types = ['image-generation', 'text-generation', 'video-generation', 'audio-generation', 'embeddings'];
    let progress = 0;
    let typeIndex = 0;
    let matchCount = 0;
    clearInterval(window.matchingProgressInterval);
    
    window.matchingProgressInterval = setInterval(() => {
        progress += Math.random() * 3 + 1;
        if (progress > 95) {
            clearInterval(window.matchingProgressInterval);
            progress = 95;
        }
        
        const progressInt = Math.floor(progress);
        document.getElementById('matchingProgressBar').style.width = progressInt + '%';
        document.getElementById('matchingProgressText').textContent = progressInt + '%';
        
        // Update type being processed
        if (progressInt > 10 && progressInt % 20 === 0 && typeIndex < types.length) {
            document.getElementById('matchingCurrentType').textContent = types[typeIndex];
            typeIndex++;
            matchCount += Math.floor(Math.random() * 5 + 1);
            document.getElementById('matchingMatchCount').textContent = matchCount;
        }
        
        // Update batch info
        const batch = Math.floor(progressInt / 10) + 1;
        const totalBatches = 10;
        document.getElementById('matchingBatchInfo').textContent = `${batch} / ${totalBatches}`;
        
        // Update status
        if (progressInt < 20) {
            document.getElementById('matchingStatusMessage').textContent = 'üîç Loading models from database...';
        } else if (progressInt < 40) {
            document.getElementById('matchingStatusMessage').textContent = 'üìä Grouping models by type...';
        } else if (progressInt < 70) {
            document.getElementById('matchingStatusMessage').textContent = 'ü§ñ Using AI to identify matches...';
        } else if (progressInt < 90) {
            document.getElementById('matchingStatusMessage').textContent = 'üíæ Creating canonical models...';
        } else {
            document.getElementById('matchingStatusMessage').textContent = '‚ú® Finalizing and saving...';
        }
        
        // Update model count
        const totalModels = 1755;
        const currentModels = Math.floor((progressInt / 100) * totalModels);
        document.getElementById('matchingModelCount').textContent = `${currentModels} / ${totalModels}`;
    }, 400);
}

function showMessage(icon, title, content) {
    document.getElementById('messageIcon').textContent = icon;
    document.getElementById('messageTitle').textContent = title;
    document.getElementById('messageContent').textContent = content;
    document.getElementById('messageCancelBtn').style.display = 'none';
    document.getElementById('messageOkBtn').textContent = 'OK';
    document.getElementById('messageModal').style.display = 'flex';
    
    return new Promise(resolve => {
        window.messageModalResolve = resolve;
    });
}

function showConfirm(icon, title, content) {
    document.getElementById('messageIcon').textContent = icon;
    document.getElementById('messageTitle').textContent = title;
    document.getElementById('messageContent').textContent = content;
    document.getElementById('messageCancelBtn').style.display = 'inline-block';
    document.getElementById('messageOkBtn').textContent = 'Continue';
    document.getElementById('messageModal').style.display = 'flex';
    
    return new Promise(resolve => {
        window.messageModalResolve = resolve;
    });
}

function closeMessageModal(result) {
    document.getElementById('messageModal').style.display = 'none';
    if (window.messageModalResolve) {
        window.messageModalResolve(result);
        window.messageModalResolve = null;
    }
}


function showEditCanonicalModal(canonicalId) {
    fetch(`/api/canonical-models/${canonicalId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editCanonicalId').value = data.id;
            document.getElementById('editCanonicalName').value = data.canonical_name || '';
            document.getElementById('editDisplayName').value = data.display_name || '';
            document.getElementById('editCanonicalDescription').value = data.description || '';
            document.getElementById('editCanonicalType').value = data.model_type || '';
            document.getElementById('editCanonicalTags').value = (data.tags || []).join(', ');
            
            document.getElementById('editCanonicalModal').style.display = 'flex';
        })
        .catch(error => {
            alert('Error loading canonical model: ' + error);
        });
}

function closeEditCanonicalModal() {
    document.getElementById('editCanonicalModal').style.display = 'none';
}

function saveCanonicalModel(event) {
    event.preventDefault();
    
    const canonicalId = document.getElementById('editCanonicalId').value;
    const tagsInput = document.getElementById('editCanonicalTags').value;
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    const data = {
        canonical_name: document.getElementById('editCanonicalName').value,
        display_name: document.getElementById('editDisplayName').value,
        description: document.getElementById('editCanonicalDescription').value,
        model_type: document.getElementById('editCanonicalType').value,
        tags: tags
    };
    
    fetch(`/api/canonical-models/${canonicalId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úì Canonical model updated successfully!');
            closeEditCanonicalModal();
            loadCanonicalModels();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function deleteCanonicalModel(canonicalId, canonicalName, providerCount) {
    if (!confirm(`Delete unified model "${canonicalName}"?\n\nThis will remove the unified model and unlink ${providerCount} provider model(s).\n\nThe individual provider models will NOT be deleted.\n\nThis action cannot be undone.`)) {
        return;
    }
    
    fetch(`/api/canonical-models/${canonicalId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì Canonical model deleted successfully!');
            loadCanonicalModels();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function showAddModelModal(canonicalId) {
    document.getElementById('addModelCanonicalId').value = canonicalId;
    document.getElementById('addModelCanonicalModal').style.display = 'flex';
    
    // Load available models
    loadAvailableModels();
}

function closeAddModelModal() {
    document.getElementById('addModelCanonicalModal').style.display = 'none';
}

function loadAvailableModels() {
    fetch('/api/ai-models?per_page=1000')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('addModelSelect');
            select.innerHTML = '<option value="">Select a model...</option>';
            
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.name} (${model.source.name})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading models:', error);
        });
}

function addModelToCanonical(event) {
    event.preventDefault();
    
    const canonicalId = document.getElementById('addModelCanonicalId').value;
    const aiModelId = document.getElementById('addModelSelect').value;
    
    if (!aiModelId) {
        alert('Please select a model');
        return;
    }
    
    const data = {
        ai_model_id: parseInt(aiModelId),
        confidence: 1.0,
        matched_by: 'manual'
    };
    
    fetch(`/api/canonical-models/${canonicalId}/models`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úì Model added successfully!');
            closeAddModelModal();
            loadCanonicalModels();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function showCreateCanonicalModal() {
    document.getElementById('createCanonicalModal').style.display = 'flex';
}

function closeCreateCanonicalModal() {
    document.getElementById('createCanonicalModal').style.display = 'none';
}

function createCanonicalModel(event) {
    event.preventDefault();
    
    const tagsInput = document.getElementById('createCanonicalTags').value;
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    const data = {
        canonical_name: document.getElementById('createCanonicalName').value,
        display_name: document.getElementById('createDisplayName').value,
        description: document.getElementById('createCanonicalDescription').value,
        model_type: document.getElementById('createCanonicalType').value,
        tags: tags
    };
    
    fetch('/api/canonical-models', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úì Canonical model created successfully!');
            closeCreateCanonicalModal();
            document.getElementById('createCanonicalForm').reset();
            loadCanonicalModels();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function removeModelFromCanonical(canonicalId, aiModelId, providerName) {
    if (!confirm(`Remove "${providerName}" from this unified model?\n\nThe individual provider model will NOT be deleted.`)) {
        return;
    }
    
    fetch(`/api/canonical-models/${canonicalId}/models/${aiModelId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì Model removed successfully!');
            loadCanonicalModels();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

async function showSuspectedMatches(canonicalId, canonicalName) {
    document.getElementById('suspectedMatchesModal').style.display = 'flex';
    document.getElementById('suspectedMatchesContent').innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #6b7280;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
            Finding potential matches for "${canonicalName}"...
        </div>
    `;
    
    try {
        const response = await fetch(`/api/canonical-models/${canonicalId}/suspected-matches?limit=10`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (data.suspects.length === 0) {
            document.getElementById('suspectedMatchesContent').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #6b7280;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úì</div>
                    <p>No suspected matches found.</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">All similar models are already matched.</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <p style="margin-bottom: 1rem; color: #6b7280;">
                Found ${data.suspects.length} models that might be the same as <strong>${canonicalName}</strong>.
                Review and add them if they match:
            </p>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
        `;
        
        data.suspects.forEach(suspect => {
            const confidence = Math.round(suspect.confidence * 100);
            const confidenceColor = confidence >= 80 ? '#10b981' : confidence >= 60 ? '#f59e0b' : '#ef4444';
            
            html += `
                <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; background: #f9fafb;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                                ${suspect.name}
                            </div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">
                                <span class="badge badge-gray">${suspect.provider}</span>
                                ${suspect.cost_per_call ? `<span style="color: #2563eb; font-weight: 600; margin-left: 0.5rem;">$${suspect.cost_per_call.toFixed(4)}</span>` : ''}
                            </div>
                            ${suspect.description ? `<div style="font-size: 0.85rem; color: #4b5563; margin-top: 0.5rem;">${suspect.description.substring(0, 150)}${suspect.description.length > 150 ? '...' : ''}</div>` : ''}
                        </div>
                        <div style="text-align: right; margin-left: 1rem;">
                            <div style="font-size: 0.75rem; color: ${confidenceColor}; font-weight: 600; margin-bottom: 0.5rem;">
                                ${confidence}% match
                            </div>
                            <button onclick="addSuspectedMatch(${canonicalId}, ${suspect.id}, '${suspect.name.replace(/'/g, "\\'")}', '${canonicalName.replace(/'/g, "\\'")}')" 
                                    class="btn-sm" style="background: #10b981;">
                                ‚ûï Add
                            </button>
                        </div>
                    </div>
                    <div style="font-size: 0.8rem; color: #6b7280; font-style: italic; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                        üí° ${suspect.reasoning}
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
        document.getElementById('suspectedMatchesContent').innerHTML = html;
        
    } catch (error) {
        document.getElementById('suspectedMatchesContent').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ùå</div>
                <p>Error loading suspected matches:</p>
                <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
            </div>
        `;
    }
}

async function addSuspectedMatch(canonicalId, modelId, modelName, canonicalName) {
    const confirmed = await showConfirm(
        '‚ûï',
        'Add Model to Group',
        `Add "${modelName}" to the "${canonicalName}" unified model?`
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/canonical-models/${canonicalId}/add-model`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                model_id: modelId,
                confidence: 0.85
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            await showMessage('‚úÖ', 'Success', 'Model added successfully to the unified group!');
            closeSuspectedMatchesModal();
            loadCanonicalModels();
        } else {
            await showMessage('‚ùå', 'Error', result.message || 'Failed to add model');
        }
    } catch (error) {
        await showMessage('‚ùå', 'Error', 'Failed to add model: ' + error.message);
    }
}

function closeSuspectedMatchesModal() {
    document.getElementById('suspectedMatchesModal').style.display = 'none';
}

</script>

<style>
.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-gray {
    background: #f3f4f6;
    color: #374151;
}

.btn {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    background: #1d4ed8;
}

.btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.btn-sm {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.35rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    font-size: 0.85rem;
}

.btn-sm:hover {
    background: #1d4ed8;
}

table {
    border-collapse: collapse;
}

tbody tr:hover {
    background: #f9fafb !important;
}
</style>
{% endblock %}
