{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>ðŸ¤– LLM Configuration</h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem;">
        Configure an LLM (via OpenRouter) to intelligently extract detailed pricing information from model descriptions.
    </p>
    
    <div style="background: #f9fafb; padding: 1rem; border-radius: 4px; margin-bottom: 2rem;">
        <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">What does this do?</h3>
        <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 0.5rem;">
            The LLM analyzes pricing text like "$0.045/sec" or "100 credits" and extracts:
        </p>
        <ul style="color: #6b7280; font-size: 0.9rem; margin-left: 1.5rem;">
            <li><strong>Pricing type</strong>: fixed, per-token, per-second, per-image, etc.</li>
            <li><strong>Cost units</strong>: tokens, seconds, images, calls, etc.</li>
            <li><strong>Pricing formula</strong>: how the cost is calculated</li>
            <li><strong>Variables</strong>: what affects the pricing (resolution, duration, etc.)</li>
        </ul>
    </div>
    
    <div style="background: #dbeafe; padding: 1rem; border-radius: 4px; margin-bottom: 2rem; border: 1px solid #93c5fd;">
        <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: #1e40af;">ðŸ”‘ Get Your OpenRouter API Key</h3>
        <p style="color: #1e40af; font-size: 0.9rem; margin-bottom: 0.5rem;">
            1. Visit <a href="https://openrouter.ai/keys" target="_blank" style="color: #2563eb; text-decoration: underline;">OpenRouter API Keys</a><br>
            2. Sign in and create a new API key<br>
            3. Copy the key and paste it below
        </p>
        <p style="color: #1e40af; font-size: 0.85rem;">
            <strong>Recommended model:</strong> openai/gpt-4o-mini (fast and affordable)
        </p>
    </div>
    
    <form method="POST" action="/llm-config/save" style="margin-bottom: 2rem;">
        <div class="form-group">
            <label>OpenRouter API Key *</label>
            <input type="password" name="api_key" required placeholder="sk-or-v1-..." 
                   value="{{ active_config.api_key if active_config else '' }}">
            <small style="color: #6b7280;">Your API key is stored securely in the database</small>
        </div>
        
        <div class="form-group">
            <label>Model Name</label>
            {% if available_models %}
                <select name="model_name" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <optgroup label="ðŸ†“ FREE MODELS">
                        {% for model in available_models %}
                            {% if model.is_free %}
                                <option value="{{ model.id }}" 
                                        {% if active_config and active_config.model_name == model.id %}selected{% endif %}>
                                    {{ model.name }} ({{ model.context_length|default('N/A', true) }} tokens) - FREE
                                </option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                    <optgroup label="â­ Recommended for Pricing Extraction">
                        {% for model in available_models %}
                            {% if model.id in recommended_models and not model.is_free %}
                                <option value="{{ model.id }}" 
                                        {% if active_config and active_config.model_name == model.id %}selected{% endif %}
                                        {% if not active_config and model.id == 'openai/gpt-4o-mini' %}selected{% endif %}>
                                    {{ model.name }}
                                    {% if model.prompt_price and model.completion_price %}
                                        (${{ "%.3f"|format(model.prompt_price|float * 1000000) }}/${{ "%.3f"|format(model.completion_price|float * 1000000) }} per 1M)
                                    {% endif %}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                    <optgroup label="All Paid Models ({{ available_models|selectattr('is_free', 'equalto', false)|list|length }} total)">
                        {% for model in available_models[:50] %}
                            {% if model.id not in recommended_models and not model.is_free %}
                                <option value="{{ model.id }}" 
                                        {% if active_config and active_config.model_name == model.id %}selected{% endif %}>
                                    {{ model.name }}
                                    {% if model.prompt_price and model.completion_price %}
                                        - ${{ "%.3f"|format(model.prompt_price|float * 1000000) }}/${{ "%.3f"|format(model.completion_price|float * 1000000) }} per 1M
                                    {% endif %}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                </select>
                <small style="color: #6b7280;">
                    {{ available_models|selectattr('is_free', 'equalto', true)|list|length }} free models available. 
                    Prices shown as prompt/completion per 1M tokens.
                </small>
            {% else %}
                <input type="text" name="model_name" placeholder="openai/gpt-4o-mini"
                       value="{{ active_config.model_name if active_config else 'openai/gpt-4o-mini' }}">
                <small style="color: #6b7280;">
                    Popular options: openai/gpt-4o-mini, anthropic/claude-3.5-sonnet, google/gemini-pro
                </small>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label>Base URL</label>
            <input type="url" name="base_url" placeholder="https://openrouter.ai/api/v1"
                   value="{{ active_config.base_url if active_config else 'https://openrouter.ai/api/v1' }}">
        </div>
        
        <button type="submit" class="btn">ðŸ’¾ Save Configuration</button>
    </form>
</div>

{% if configs %}
<div class="card">
    <h2>Saved Configurations</h2>
    <table>
        <thead>
            <tr>
                <th>Model</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for config in configs %}
            <tr>
                <td>
                    <strong>{{ config.model_name }}</strong>
                    <br><small style="color: #6b7280;">{{ config.provider }}</small>
                </td>
                <td>
                    {% if config.is_active %}
                        <span class="badge badge-green">Active</span>
                    {% else %}
                        <span class="badge badge-gray">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ config.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    {% if not config.is_active %}
                    <form method="POST" action="/llm-config/{{ config.id }}/activate" style="display: inline;">
                        <button type="submit" class="btn btn-small btn-success">Activate</button>
                    </form>
                    {% endif %}
                    <form method="POST" action="/llm-config/{{ config.id }}/delete" style="display: inline;">
                        <button type="submit" class="btn btn-small btn-danger" 
                                onclick="return confirm('Delete this configuration?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="card">
    <h2>Usage</h2>
    <p style="color: #6b7280; margin-bottom: 1rem;">Once configured, use the LLM extraction when importing models:</p>
    
    <h3 style="font-size: 1rem; margin: 1.5rem 0 0.5rem;">Command Line:</h3>
    <pre style="background: #1f2937; color: #f3f4f6; padding: 1rem; border-radius: 4px; overflow-x: auto;">python manage.py extract --use-llm</pre>
    
    <h3 style="font-size: 1rem; margin: 1.5rem 0 0.5rem;">What You'll See:</h3>
    <p style="color: #6b7280; font-size: 0.9rem;">Each model will show additional pricing details in the database:</p>
    <ul style="color: #6b7280; font-size: 0.9rem; margin-left: 1.5rem;">
        <li><code>pricing_type</code>: How pricing is structured</li>
        <li><code>pricing_formula</code>: Human-readable calculation method</li>
        <li><code>cost_unit</code>: Unit of measurement (tokens, seconds, etc.)</li>
        <li><code>input_cost_per_unit</code>: Cost per input unit</li>
        <li><code>output_cost_per_unit</code>: Cost per output unit</li>
        <li><code>pricing_variables</code>: Variables that affect cost</li>
    </ul>
    
    <h3 style="font-size: 1rem; margin: 1.5rem 0 0.5rem;">Example Output:</h3>
    <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb; font-size: 0.85rem; overflow-x: auto;">Extracting from: Fal.ai
  ðŸ¤– LLM pricing extraction enabled
  Fetching models from fal.ai...
  âœ“ LLM extracted pricing for FLUX1.1 [pro]
    Type: per_second
    Formula: $0.045 per second
    Unit: seconds</pre>
</div>
{% endblock %}
