{% extends "base.html" %}

{% block title %}Settings - AI Cost Manager{% endblock %}

{% block extra_styles %}
<style>
    .tabs {
        display: flex;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 2rem;
        gap: 0.5rem;
    }
    
    .tab {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #6b7280;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tab:hover {
        color: #2563eb;
        background: #f9fafb;
    }
    
    .tab.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
        font-weight: 600;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .api-key-input {
        position: relative;
    }
    
    .api-key-input input {
        padding-right: 100px;
    }
    
    .toggle-key {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }
    
    .toggle-key:hover {
        color: #2563eb;
    }
    
    .help-text {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .key-status {
        display: inline-block;
        margin-left: 0.5rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .key-status.configured {
        background: #d1fae5;
        color: #065f46;
    }
    
    .key-status.missing {
        background: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>‚öôÔ∏è Settings</h2>
    
    <div class="tabs">
        <button class="tab active" data-tab="llm">LLM Configuration</button>
        <button class="tab" data-tab="extractors">Extractor API Keys</button>
        <button class="tab" data-tab="maintenance">Maintenance</button>
    </div>
    
    <!-- LLM Configuration Tab -->
    <div class="tab-content active" id="llm-tab">
        <h3 class="section-title">LLM API Configuration</h3>
        
        <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #bfdbfe;">
            <p style="color: #1e40af; font-size: 0.9rem; margin: 0;">
                Configure separate LLMs for different purposes:<br>
                <strong>üîç Extraction:</strong> Parses pricing & model names during extraction<br>
                <strong>üîé Search:</strong> Powers semantic AI search with natural language
            </p>
        </div>
        
        <!-- Extraction LLM Configuration -->
        <div class="card" style="background: #f0fdf4; border: 2px solid #10b981; margin-bottom: 2rem;">
            <h4 style="margin-top: 0; color: #065f46;">üîç Extraction LLM</h4>
            <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                Used for extracting pricing details and parsing model name components (company, version, size, etc.)
            </p>
            
            <form method="POST" action="/settings/llm">
                <input type="hidden" name="purpose" value="extraction">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="extraction_model">Model</label>
                        <select id="extraction_model" name="model_name" required>
                            {% if available_models %}
                                <optgroup label="üÜì FREE MODELS">
                                    {% for model in available_models if model.is_free %}
                                        <option value="{{ model.id }}"
                                                {% if llm_extraction and llm_extraction.model_name == model.id %}selected{% endif %}>
                                            {{ model.name }} - FREE
                                        </option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="‚≠ê RECOMMENDED">
                                    {% for model in available_models if model.id in recommended_models and not model.is_free %}
                                        <option value="{{ model.id }}"
                                                {% if llm_extraction and llm_extraction.model_name == model.id %}selected{% endif %}
                                                {% if not llm_extraction and model.id == 'openai/gpt-4o-mini' %}selected{% endif %}>
                                            {{ model.name }} - ${{ "%.2f"|format(model.prompt_price|float * 1000000) }}/1M
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% else %}
                                <option value="openai/gpt-4o-mini" selected>GPT-4o Mini (recommended)</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="extraction_api_key">API Key</label>
                        <div class="api-key-input">
                            <input type="password" id="extraction_api_key" name="api_key" 
                                   value="{{ llm_extraction.api_key if llm_extraction else '' }}" 
                                   placeholder="sk-or-v1-..." required>
                            <button type="button" class="toggle-key" onclick="togglePassword('extraction_api_key')">Show</button>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" name="base_url" value="https://openrouter.ai/api/v1">
                <input type="hidden" name="is_active" value="1">
                
                <button type="submit" class="btn" style="background: #10b981; color: white;">
                    üíæ Save Extraction LLM
                </button>
                
                {% if llm_extraction %}
                <span style="color: #065f46; margin-left: 1rem;">
                    ‚úì Currently: {{ llm_extraction.model_name }}
                </span>
                {% endif %}
            </form>
        </div>
        
        <!-- Search LLM Configuration -->
        <div class="card" style="background: #eff6ff; border: 2px solid #3b82f6; margin-bottom: 2rem;">
            <h4 style="margin-top: 0; color: #1e40af;">üîé Search LLM</h4>
            <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                Used for semantic AI-powered model search. Free models like Gemini Flash work great!
            </p>
            
            <form method="POST" action="/settings/llm">
                <input type="hidden" name="purpose" value="search">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="search_model">Model</label>
                        <select id="search_model" name="model_name" required>
                            {% if available_models %}
                                <optgroup label="üÜì FREE MODELS (Best for Search)">
                                    {% for model in available_models if model.is_free %}
                                        <option value="{{ model.id }}"
                                                {% if llm_search and llm_search.model_name == model.id %}selected{% endif %}
                                                {% if not llm_search and model.id == 'google/gemini-flash-1.5' %}selected{% endif %}>
                                            {{ model.name }} - FREE
                                        </option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="Paid Models">
                                    {% for model in available_models[:20] if not model.is_free %}
                                        <option value="{{ model.id }}"
                                                {% if llm_search and llm_search.model_name == model.id %}selected{% endif %}>
                                            {{ model.name }} - ${{ "%.2f"|format(model.prompt_price|float * 1000000) }}/1M
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% else %}
                                <option value="google/gemini-flash-1.5" selected>Gemini Flash 1.5 (FREE)</option>
                                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="search_api_key">API Key</label>
                        <div class="api-key-input">
                            <input type="password" id="search_api_key" name="api_key" 
                                   value="{{ llm_search.api_key if llm_search else (llm_extraction.api_key if llm_extraction else '') }}" 
                                   placeholder="sk-or-v1-... (can reuse extraction key)" required>
                            <button type="button" class="toggle-key" onclick="togglePassword('search_api_key')">Show</button>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" name="base_url" value="https://openrouter.ai/api/v1">
                <input type="hidden" name="is_active" value="1">
                
                <button type="submit" class="btn" style="background: #3b82f6; color: white;">
                    üíæ Save Search LLM
                </button>
                
                {% if llm_search %}
                <span style="color: #1e40af; margin-left: 1rem;">
                    ‚úì Currently: {{ llm_search.model_name }}
                </span>
                {% endif %}
            </form>
        </div>
        
        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb;">
            <p style="font-size: 0.9rem; color: #6b7280; margin: 0;">
                üí° <strong>Tip:</strong> You can use the same API key for both, but different models. 
                Get your key at <a href="https://openrouter.ai/keys" target="_blank" style="color: #2563eb;">OpenRouter</a>
            </p>
        </div>
    </div>
    
    <!-- Extractor API Keys Tab -->
    <div class="tab-content" id="extractors-tab">
        <h3 class="section-title">Extractor API Keys & Authentication</h3>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">
            Configure API keys and authentication for different data extractors. These are optional - extractors will use fallback methods if not provided.
        </p>
        
        <form method="POST" action="/settings/extractors">
            <!-- Together AI -->
            <div class="form-group">
                <label for="together_api_key">
                    <strong>Together AI</strong> - API Key
                    {% if together_key %}
                        <span class="key-status configured">‚úì Configured</span>
                    {% else %}
                        <span class="key-status missing">Not configured</span>
                    {% endif %}
                </label>
                <div class="api-key-input">
                    <input type="password" id="together_api_key" name="together_api_key" 
                           value="{{ together_key.api_key if together_key else '' }}" 
                           placeholder="Enter your Together AI API key">
                    <button type="button" class="toggle-key" onclick="togglePassword('together_api_key')">Show</button>
                </div>
                <div class="help-text">
                    Get your API key from <a href="https://api.together.xyz/settings/api-keys" target="_blank">Together AI</a>. 
                    If not provided, will scrape public pricing page.
                </div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="together_active" {{ 'checked' if not together_key or together_key.is_active else '' }}>
                    Active
                </label>
                <div class="help-text">Enable Together AI API key usage</div>
            </div>
            
            <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e5e7eb;">
            
            <!-- fal.ai Authentication -->
            <div class="form-group">
                <label for="wos_session">
                    <strong>fal.ai</strong> - Session Cookie (wos-session)
                    {% if fal_auth and fal_auth.is_active %}
                        <span class="key-status configured">‚úì Configured</span>
                    {% else %}
                        <span class="key-status missing">Not configured</span>
                    {% endif %}
                </label>
                <div class="api-key-input">
                    <input type="password" id="wos_session" name="wos_session" 
                           value="{{ fal_auth.cookies|from_json|attr('wos-session') if fal_auth and fal_auth.cookies else '' }}" 
                           placeholder="Fe26.2*1*0fbdfe67...">
                    <button type="button" class="toggle-key" onclick="togglePassword('wos_session')">Show</button>
                </div>
                <details style="margin-top: 0.5rem;">
                    <summary style="cursor: pointer; color: #2563eb; font-size: 0.85rem;">How to get the wos-session cookie?</summary>
                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f9fafb; border-radius: 4px; font-size: 0.85rem;">
                        <p><strong>Quick Steps:</strong></p>
                        <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            <li>Login to <a href="https://fal.ai" target="_blank">fal.ai</a></li>
                            <li>Press <kbd>F12</kbd> ‚Üí go to <strong>Application</strong> tab</li>
                            <li>Expand <strong>Cookies</strong> ‚Üí click <code>https://fal.ai</code></li>
                            <li>Find <code>wos-session</code> and copy its value (starts with <code>Fe26.2*1*</code>)</li>
                        </ol>
                        <p style="margin-top: 0.5rem;"><strong>Note:</strong> Needed for accurate playground pricing ($0.00111 instead of $0). Cookie may expire after several days.</p>
                    </div>
                </details>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="fal_active" {{ 'checked' if not fal_auth or fal_auth.is_active else '' }}>
                    Active
                </label>
                <div class="help-text">Enable fal.ai authentication for accurate pricing</div>
            </div>
            
            <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e5e7eb;">
            
            <!-- Runware Authentication -->
            <div class="form-group">
                <label for="runware_username">
                    <strong>Runware</strong> - Email
                    {% if runware_auth and runware_auth.is_active %}
                        <span class="key-status configured">‚úì Configured</span>
                    {% else %}
                        <span class="key-status missing">Not configured</span>
                    {% endif %}
                </label>
                <input type="email" id="runware_username" name="runware_username" 
                       value="{{ runware_auth.username if runware_auth else '' }}" 
                       placeholder="your-email@example.com">
                <div class="help-text">
                    Your Runware account email for authentication. Required for extracting 189+ certified models.
                </div>
            </div>
            
            <div class="form-group">
                <label for="runware_password">
                    <strong>Runware</strong> - Password
                </label>
                <div class="api-key-input">
                    <input type="password" id="runware_password" name="runware_password" 
                           value="{{ runware_auth.password if runware_auth else '' }}" 
                           placeholder="Your Runware password">
                    <button type="button" class="toggle-key" onclick="togglePassword('runware_password')">Show</button>
                </div>
                <div class="help-text">
                    Your Runware account password. 
                    <a href="https://my.runware.ai/login" target="_blank">Create account</a> if you don't have one.
                </div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="runware_active" {{ 'checked' if not runware_auth or runware_auth.is_active else '' }}>
                    Active
                </label>
                <div class="help-text">Enable Runware authentication for extracting certified models</div>
            </div>
            
            <button type="submit" class="btn btn-success">Save All Extractor Settings</button>
        </form>
    </div>
    
    <!-- Maintenance Tab -->
    <div class="tab-content" id="maintenance-tab">
        <h3 class="section-title">Database Maintenance</h3>
        
        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin-bottom: 1rem;">
            <h4 style="margin-top: 0; color: #92400e;">‚ö†Ô∏è Run Migration 011</h4>
            <p class="help-text" style="margin-bottom: 1rem; color: #92400e;">
                If you're seeing errors about "column purpose does not exist", click this button to add the missing column.
                This is a one-time migration.
            </p>
            <button type="button" class="btn" style="background: #f59e0b; color: white;" onclick="runMigration011()">
                üîß Run Migration 011
            </button>
            <div id="migration-result" style="margin-top: 1rem;"></div>
        </div>
        
        <div class="card">
            <h4 style="margin-top: 0;">Parse Model Names</h4>
            <p class="help-text" style="margin-bottom: 1rem;">
                Extract structured components (company, version, size, etc.) from all model names.
                This improves search accuracy and enables version-aware filtering.
            </p>
            <button type="button" class="btn btn-primary" onclick="parseAllModels()">
                üîÑ Parse All Models
            </button>
            <div id="parse-result" style="margin-top: 1rem;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
        });
    });
    
    // Toggle password visibility
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;
        
        if (input.type === 'password') {
            input.type = 'text';
            button.textContent = 'Hide';
        } else {
            input.type = 'password';
            button.textContent = 'Show';
        }
    }
    
    // Parse all models
    async function parseAllModels() {
        const button = event.target;
        const resultDiv = document.getElementById('parse-result');
        
        button.disabled = true;
        button.textContent = '‚è≥ Parsing...';
        resultDiv.innerHTML = '<div class="alert alert-info">Parsing models, please wait...</div>';
        
        try {
            const response = await fetch('/api/parse-all-models', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-success">
                        <strong>‚úì Success!</strong> ${data.message}
                    </div>
                    <div style="margin-top: 1rem;">
                        <p><strong>Statistics:</strong></p>
                        <ul>
                            <li>Total models: ${data.total}</li>
                            <li>Updated: ${data.updated}</li>
                            ${data.error_count > 0 ? `<li>Errors: ${data.error_count}</li>` : ''}
                        </ul>
                `;
                
                if (data.examples && data.examples.length > 0) {
                    html += `
                        <p style="margin-top: 1rem;"><strong>Examples:</strong></p>
                        <table class="table" style="font-size: 0.9rem;">
                            <tr>
                                <th>Model Name</th>
                                <th>Company</th>
                                <th>Family</th>
                                <th>Version</th>
                                <th>Size</th>
                            </tr>
                    `;
                    
                    data.examples.forEach(ex => {
                        html += `
                            <tr>
                                <td>${ex.name}</td>
                                <td>${ex.company || '-'}</td>
                                <td>${ex.family || '-'}</td>
                                <td>${ex.version || '-'}</td>
                                <td>${ex.size || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚úó Error:</strong> ${data.error}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚úó Error:</strong> ${error.message}
                </div>
            `;
        }
    }
    
    // Run Migration 011
    async function runMigration011() {
        const resultDiv = document.getElementById('migration-result');
        resultDiv.innerHTML = '<p style="color: #3b82f6;">üîß Running migration...</p>';
        
        try {
            const response = await fetch('/api/run-migration-011', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úì Success!</strong> ${data.message}
                        <p style="margin-top: 0.5rem;">You can now reload the page.</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚úó Error:</strong> ${data.error}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚úó Error:</strong> ${error.message}
                </div>
            `;
        } finally {
            button.disabled = false;
            button.textContent = 'üîÑ Parse All Models';
        }
    }
</script>
{% endblock %}
